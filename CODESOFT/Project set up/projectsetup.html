<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Project Manager (Single File)</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#00b894;
    --accent-2:#0984e3; --danger:#ff7675; --glass: rgba(255,255,255,0.03);
    --radius:12px; --mono: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  html,body{height:100%; margin:0; font-family:var(--mono); background:
    linear-gradient(180deg,#071021 0%, #081226 60%); color:#e6eef6;}
  .app{
    max-width:1100px; margin:28px auto; padding:24px; border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
    box-shadow: 0 8px 30px rgba(2,6,23,0.6); overflow:hidden;
  }
  header{display:flex; align-items:center; gap:16px; margin-bottom:18px;}
  header h1{margin:0; font-size:20px; letter-spacing:0.4px;}
  header .small{color:var(--muted); font-size:13px;}
  .layout{display:grid; grid-template-columns:300px 1fr; gap:18px;}
  aside{background:var(--card); border-radius:12px; padding:14px; min-height:420px;}
  main{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:14px; border-radius:12px; min-height:420px;}
  .btn{display:inline-block; background:var(--accent); color:#042023; padding:8px 12px; border-radius:8px; font-weight:600; text-decoration:none; cursor:pointer; border:none;}
  .btn.secondary{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03);}
  .flex{display:flex; gap:8px; align-items:center;}
  .projects-list{margin-top:12px; display:flex; flex-direction:column; gap:8px;}
  .project-card{background:var(--glass); padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:transform .12s; border:1px solid rgba(255,255,255,0.02);}
  .project-card:hover{transform:translateY(-3px)}
  .project-card.active{outline:2px solid rgba(0,184,148,0.12); box-shadow:0 6px 20px rgba(2,6,23,0.6);}
  form.row{display:flex; gap:8px; margin-top:12px;}
  form.row input, form.row textarea, select, input[type=date]{background:transparent; border:1px dashed rgba(255,255,255,0.04); padding:8px; color:inherit; border-radius:8px; width:100%;}
  .meta{color:var(--muted); font-size:13px;}
  .tasks{display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:12px;}
  .task{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border-left:6px solid rgba(255,255,255,0.03);}
  .task h4{margin:0 0 6px 0;}
  .tag{display:inline-block; padding:4px 8px; border-radius:8px; font-size:12px; background:rgba(255,255,255,0.03); color:var(--muted);}
  .status.todo{border-color:#ffb86b}
  .status.in-progress{border-color:#0984e3}
  .status.done{border-color:#00b894}
  .small-muted{color:var(--muted); font-size:12px}
  .progress-bar{height:10px; width:100%; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden;}
  .progress-bar > i{height:100%; display:block; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%;}
  .controls{display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap}
  .users-list{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
  .avatar{width:34px; height:34px; border-radius:50%; display:inline-grid; place-items:center; font-weight:700; background:rgba(255,255,255,0.03); color:var(--muted)}
  .muted{color:var(--muted)}
  .tiny{font-size:12px}
  .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); font-size:13px;}
  .link-like{background:none; border:none; color:var(--accent); cursor:pointer; font-weight:600}
  .footer-row{display:flex; justify-content:space-between; align-items:center; margin-top:14px; color:var(--muted); font-size:13px;}
  .search{width:100%; padding:8px; border-radius:8px; margin-top:12px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit}
  .top-actions{display:flex; gap:8px; align-items:center; margin-left:auto;}
  .controls .small{font-size:12px}
  .empty{padding:18px; text-align:center; color:var(--muted); border:1px dashed rgba(255,255,255,0.03); border-radius:10px;}
  /* responsive */
  @media (max-width:880px){
    .layout{grid-template-columns:1fr; }
    aside{order:2}
    main{order:1}
  }
  /* small icons */
  .ico{opacity:.9; margin-right:6px}
  .danger{background:var(--danger); color:#5b0b0b}
  input[type=range]{width:160px}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Project Manager Single File App">
  <header>
    <div>
      <h1>Project Manager</h1>
      <div class="small muted">Single-file HTML • stores data in your browser (localStorage)</div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnExport">Export JSON</button>
      <button class="btn secondary" id="btnImport">Import JSON</button>
      <button class="btn secondary" id="btnReset">Reset Sample Data</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="flex" style="justify-content:space-between;align-items:center;">
        <strong>Projects</strong>
        <button class="pill" id="btnNewProject">+ New</button>
      </div>

      <input class="search" id="projectSearch" placeholder="Search projects..." aria-label="Search projects">

      <div class="projects-list" id="projectsList" aria-live="polite"></div>

      <div style="margin-top:12px;">
        <div class="small muted">Quick Filters</div>
        <div class="controls" style="margin-top:8px;">
          <select id="filterStatus" title="Filter by task status">
            <option value="all">All tasks</option>
            <option value="hasOverdue">Has overdue</option>
            <option value="noTasks">No tasks</option>
          </select>
          <select id="sortProjects" title="Sort projects">
            <option value="recent">Recently created</option>
            <option value="alpha">Alphabetical</option>
            <option value="progress">Least progress</option>
          </select>
        </div>
      </div>

      <hr style="border:none; height:1px; background:rgba(255,255,255,0.02); margin:12px 0;">

      <div>
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <strong>Team / Users</strong>
          <button class="pill" id="btnAddUser">+ Add</button>
        </div>
        <div class="users-list" id="usersList"></div>
        <div style="margin-top:8px;">
          <input id="userName" placeholder="User name" style="width:100%; padding:8px; border-radius:8px; background:transparent; border:1px dashed rgba(255,255,255,0.03); margin-top:8px;" />
          <input id="userEmail" placeholder="Email (optional)" style="width:100%; padding:8px; border-radius:8px; background:transparent; border:1px dashed rgba(255,255,255,0.03); margin-top:6px;" />
        </div>
      </div>

      <div class="footer-row" style="margin-top:14px;">
        <div class="muted tiny">Stored: <span id="storageInfo">—</span></div>
        <div><button class="link-like" id="btnHelp">Help</button></div>
      </div>
    </aside>

    <main>
      <div id="mainArea">
        <div id="emptyView" class="empty">
          <strong>No project selected</strong>
          <div class="muted tiny" style="margin-top:8px">Create a project on the left or click the sample project to begin.</div>
        </div>

        <div id="projectView" style="display:none">
          <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
            <div>
              <h2 id="projTitle" style="margin:0"></h2>
              <div class="meta" id="projMeta"></div>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <div style="min-width:220px">
                <div class="small-muted tiny">Progress</div>
                <div class="progress-bar" aria-hidden="true"><i id="projProgressFill"></i></div>
                <div class="muted tiny" id="projProgressLabel">0%</div>
              </div>
              <div class="controls">
                <button class="btn" id="btnAddTask">+ Task</button>
                <button class="btn secondary" id="btnEditProject">Edit</button>
                <button class="btn secondary danger" id="btnDeleteProject">Delete</button>
              </div>
            </div>
          </div>

          <div style="display:flex; gap:14px; margin-top:12px; align-items:flex-start;">
            <div style="flex:1">
              <div style="display:flex; gap:8px; align-items:center">
                <input id="taskSearch" class="search" placeholder="Search tasks..." />
                <select id="taskFilter">
                  <option value="all">All</option>
                  <option value="todo">Todo</option>
                  <option value="in-progress">In Progress</option>
                  <option value="done">Done</option>
                </select>
                <select id="taskSort">
                  <option value="created">Newest</option>
                  <option value="due">Due soon</option>
                  <option value="priority">Priority</option>
                </select>
                <div style="margin-left:auto" class="small muted">Tasks: <span id="tasksCount">0</span></div>
              </div>

              <div class="tasks" id="tasksGrid" aria-live="polite"></div>
            </div>

            <aside style="width:300px; padding:12px;">
              <div style="margin-bottom:10px;">
                <strong>New Task</strong>
                <div class="muted tiny">Quick add a task to this project</div>
              </div>
              <form id="taskForm" onsubmit="return false;">
                <input id="newTaskTitle" placeholder="Task title" required/>
                <textarea id="newTaskDesc" placeholder="Description" rows="3" style="margin-top:8px;"></textarea>
                <div style="display:flex; gap:8px; margin-top:8px;">
                  <select id="newTaskAssignee">
                    <option value="">Unassigned</option>
                  </select>
                  <select id="newTaskPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                  <input type="date" id="newTaskDue"/>
                  <select id="newTaskStatus">
                    <option value="todo">Todo</option>
                    <option value="in-progress">In Progress</option>
                    <option value="done">Done</option>
                  </select>
                </div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                  <button class="btn" id="submitTask">Add Task</button>
                  <button class="btn secondary" id="clearTask">Clear</button>
                </div>
              </form>

              <hr style="margin:12px 0; border:none; height:1px; background:rgba(255,255,255,0.02)">

              <div>
                <strong>Project Members</strong>
                <div class="users-list" id="projectMembers"></div>
                <div style="margin-top:8px;">
                  <select id="addMemberSelect" style="width:100%"><option value="">Add member...</option></select>
                  <button class="btn" id="btnAddMember" style="margin-top:8px">Add to project</button>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
/*
  Project Manager - Single file app
  - Stores data in localStorage under key 'pm_data_v1'
  - Data model: { users:[], projects:[], tasks:[] }
  - Each project: { id, title, description, ownerId, members:[], createdAt }
  - Each task: { id, projectId, title, description, assigneeId, status, priority, dueDate, createdAt }
*/

(() => {
  // Utilities
  const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
  const now = ()=> new Date().toISOString();
  const lsKey = 'pm_data_v1';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // Default sample data
  const sample = {
    users:[
      { id:'u1', name:'Alice', email:'alice@example.com', createdAt: now() },
      { id:'u2', name:'Bob', email:'bob@example.com', createdAt: now() },
      { id:'u3', name:'Dev', email:'dev@example.com', createdAt: now() }
    ],
    projects:[
      { id:'p1', title:'Marketing Website', description:'Redesign marketing site and landing pages', ownerId:'u1', members:['u1','u2'], createdAt: now() },
      { id:'p2', title:'Mobile App', description:'Build the mobile app MVP', ownerId:'u2', members:['u2','u3'], createdAt: now() }
    ],
    tasks:[
      { id:'t1', projectId:'p1', title:'Design hero section', description:'Create hero variants', assigneeId:'u1', status:'in-progress', priority:'high', dueDate: addDays(3), createdAt: now() },
      { id:'t2', projectId:'p1', title:'Setup analytics', description:'Google Analytics + events', assigneeId:'u2', status:'todo', priority:'medium', dueDate: addDays(7), createdAt: now() },
      { id:'t3', projectId:'p2', title:'Auth screens', description:'Login & signup', assigneeId:'u3', status:'todo', priority:'high', dueDate: addDays(-2), createdAt: now() }, // overdue
      { id:'t4', projectId:'p2', title:'API contract', description:'Define endpoints and payloads', assigneeId:null, status:'todo', priority:'low', dueDate: addDays(10), createdAt: now() }
    ]
  };

  function addDays(n){
    const d = new Date();
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }

  // App state
  let state = loadState();
  let selectedProjectId = null;

  // DOM refs
  const projectsList = $('#projectsList');
  const usersList = $('#usersList');
  const storageInfo = $('#storageInfo');
  const btnNewProject = $('#btnNewProject');
  const btnAddUser = $('#btnAddUser');
  const btnExport = $('#btnExport');
  const btnImport = $('#btnImport');
  const btnReset = $('#btnReset');
  const btnHelp = $('#btnHelp');

  const projectSearch = $('#projectSearch');
  const filterStatus = $('#filterStatus');
  const sortProjects = $('#sortProjects');

  const mainArea = $('#mainArea');
  const emptyView = $('#emptyView');
  const projectView = $('#projectView');
  const projTitle = $('#projTitle');
  const projMeta = $('#projMeta');
  const projProgressFill = $('#projProgressFill');
  const projProgressLabel = $('#projProgressLabel');
  const btnAddTask = $('#btnAddTask');
  const btnEditProject = $('#btnEditProject');
  const btnDeleteProject = $('#btnDeleteProject');

  const taskSearch = $('#taskSearch');
  const taskFilter = $('#taskFilter');
  const taskSort = $('#taskSort');
  const tasksGrid = $('#tasksGrid');
  const tasksCount = $('#tasksCount');

  // New Task form
  const newTaskTitle = $('#newTaskTitle');
  const newTaskDesc = $('#newTaskDesc');
  const newTaskAssignee = $('#newTaskAssignee');
  const newTaskPriority = $('#newTaskPriority');
  const newTaskDue = $('#newTaskDue');
  const newTaskStatus = $('#newTaskStatus');
  const submitTask = $('#submitTask');
  const clearTask = $('#clearTask');

  const projectMembersDiv = $('#projectMembers');
  const addMemberSelect = $('#addMemberSelect');
  const btnAddMember = $('#btnAddMember');

  // Init
  renderAll();

  // Event listeners
  btnNewProject.addEventListener('click', ()=>openCreateProject());
  btnAddUser.addEventListener('click', addUserFromInputs);
  btnExport.addEventListener('click', exportJSON);
  btnImport.addEventListener('click', importJSON);
  btnReset.addEventListener('click', ()=>{ if(confirm('Load sample data? This will replace current data.')) { state = clone(sample); saveState(); selectedProjectId=null; renderAll(); }} );
  btnHelp.addEventListener('click', ()=>showHelp());

  projectSearch.addEventListener('input', renderProjectsList);
  filterStatus.addEventListener('change', renderProjectsList);
  sortProjects.addEventListener('change', renderProjectsList);

  taskSearch.addEventListener('input', renderTasksForSelected);
  taskFilter.addEventListener('change', renderTasksForSelected);
  taskSort.addEventListener('change', renderTasksForSelected);

  btnAddTask.addEventListener('click', ()=>{ newTaskTitle.focus(); });
  submitTask.addEventListener('click', createTaskFromForm);
  clearTask.addEventListener('click', clearTaskForm);

  btnEditProject.addEventListener('click', editSelectedProject);
  btnDeleteProject.addEventListener('click', deleteSelectedProject);

  btnAddMember.addEventListener('click', addMemberToProject);

  // User inputs
  $('#userName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addUserFromInputs(); }});
  $('#userEmail').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addUserFromInputs(); }});

  // Keyboard shortcut: n = new project, t = add task, u = add user
  window.addEventListener('keydown', (e)=>{
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if(e.key === 'n') openCreateProject();
    if(e.key === 'u') $('#userName').focus();
    if(e.key === 't' && selectedProjectId) newTaskTitle.focus();
  });

  // -------------------------
  // Data handling
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function loadState(){
    try {
      const raw = localStorage.getItem(lsKey);
      if(!raw) {
        localStorage.setItem(lsKey, JSON.stringify(sample));
        return clone(sample);
      }
      return JSON.parse(raw);
    } catch(e){
      console.error('load error', e);
      localStorage.setItem(lsKey, JSON.stringify(sample));
      return clone(sample);
    }
  }

  function saveState(){
    localStorage.setItem(lsKey, JSON.stringify(state));
    storageInfo.textContent = new Date().toLocaleString();
  }

  function exportJSON(){
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pm-data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const input = document.createElement('input');
    input.type='file';
    input.accept='application/json';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const txt = await file.text();
      try {
        const parsed = JSON.parse(txt);
        if(!parsed.projects || !parsed.tasks || !parsed.users) throw new Error('Invalid data format');
        if(!confirm('Importing will replace current data. Continue?')) return;
        state = parsed;
        saveState();
        selectedProjectId = null;
        renderAll();
      } catch(err) {
        alert('Failed to import: ' + err.message);
      }
    };
    input.click();
  }

  // -------------------------
  // Rendering
  function renderAll(){
    renderProjectsList();
    renderUsers();
    storageInfo.textContent = new Date().toLocaleString();
    renderProjectSelectOptions();
    renderProjectView();
  }

  function renderProjectsList(){
    const q = projectSearch.value.toLowerCase().trim();
    let projects = clone(state.projects || []);
    // apply quick filters
    const f = filterStatus.value;
    if(f === 'hasOverdue'){
      projects = projects.filter(p => state.tasks.some(t => t.projectId === p.id && t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'done'));
    } else if(f === 'noTasks'){
      projects = projects.filter(p => !state.tasks.some(t => t.projectId === p.id));
    }
    // search
    if(q) {
      projects = projects.filter(p => p.title.toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q));
    }
    // sorting
    const sort = sortProjects.value;
    if(sort === 'alpha') projects.sort((a,b)=>a.title.localeCompare(b.title));
    else if(sort === 'progress') projects.sort((a,b)=> getProjectProgress(a.id) - getProjectProgress(b.id));
    else projects.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

    projectsList.innerHTML = '';
    if(projects.length === 0) {
      projectsList.innerHTML = '<div class="muted tiny" style="padding:10px">No projects yet</div>';
      return;
    }
    projects.forEach(p => {
      const el = document.createElement('div');
      el.className = 'project-card' + (p.id === selectedProjectId ? ' active' : '');
      el.setAttribute('data-id', p.id);
      el.innerHTML = `
        <div>
          <div style="font-weight:700">${escapeHtml(p.title)}</div>
          <div class="meta tiny">${escapeHtml((p.description||'').slice(0,60))}</div>
          <div class="small-muted tiny" style="margin-top:6px">Owner: ${getUserName(p.ownerId)||'—'}</div>
        </div>
        <div style="text-align:right">
          <div class="muted tiny">${getProjectProgress(p.id)}%</div>
          <div class="small-muted tiny" style="margin-top:6px">${taskCountForProject(p.id)} tasks</div>
        </div>
      `;
      el.addEventListener('click', ()=>selectProject(p.id));
      projectsList.appendChild(el);
    });
  }

  function renderUsers(){
    usersList.innerHTML = '';
    state.users.forEach(u => {
      const a = document.createElement('div');
      a.style.display='flex'; a.style.alignItems='center'; a.style.gap='8px';
      a.innerHTML = `<div class="avatar" title="${escapeHtml(u.email||'')}">${escapeHtml(shortName(u.name))}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(u.name)}</div>
          <div class="small-muted tiny">${escapeHtml(u.email||'')}</div>
        </div>
        <div>
          <button class="link-like" data-id="${u.id}">Remove</button>
        </div>`;
      const btn = a.querySelector('button');
      btn.addEventListener('click', ()=>{ if(confirm('Remove user? This will unassign their tasks.')) { removeUser(u.id); }});
      usersList.appendChild(a);
    });
    // populate selects
    renderProjectSelectOptions();
  }

  function renderProjectSelectOptions(){
    // member add select and task assignee select
    addMemberSelect.innerHTML = '<option value="">Add member...</option>';
    newTaskAssignee.innerHTML = '<option value="">Unassigned</option>';
    state.users.forEach(u=>{
      addMemberSelect.innerHTML += `<option value="${u.id}">${escapeHtml(u.name)}</option>`;
      newTaskAssignee.innerHTML += `<option value="${u.id}">${escapeHtml(u.name)}</option>`;
    });
  }

  function renderProjectView(){
    if(!selectedProjectId){
      projectView.style.display='none';
      emptyView.style.display='block';
      return;
    }
    const project = state.projects.find(p=>p.id===selectedProjectId);
    if(!project){ selectedProjectId=null; renderAll(); return; }
    emptyView.style.display='none';
    projectView.style.display='block';
    projTitle.textContent = project.title;
    const ownerName = getUserName(project.ownerId) || '—';
    projMeta.innerHTML = `<span class="muted tiny">Owner: ${escapeHtml(ownerName)}</span> — <span class="muted tiny">Created: ${new Date(project.createdAt).toLocaleString()}</span>`;
    const prog = getProjectProgress(project.id);
    projProgressFill.style.width = prog + '%';
    projProgressLabel.textContent = prog + '%';
    renderTasksForSelected();
    renderProjectMembers();
  }

  function renderTasksForSelected(){
    if(!selectedProjectId) return;
    const q = taskSearch.value.toLowerCase().trim();
    let tasks = state.tasks.filter(t=>t.projectId === selectedProjectId);
    // filter by status
    const f = taskFilter.value;
    if(f !== 'all') tasks = tasks.filter(t=>t.status === f);
    // search
    if(q) tasks = tasks.filter(t => (t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q) );
    // sort
    const s = taskSort.value;
    if(s === 'due') tasks.sort((a,b)=>{
      if(!a.dueDate) return 1;
      if(!b.dueDate) return -1;
      return new Date(a.dueDate) - new Date(b.dueDate);
    });
    else if(s === 'priority'){
      const rank = { high:1, medium:2, low:3 };
      tasks.sort((a,b)=> rank[a.priority]-rank[b.priority]);
    } else {
      tasks.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
    }

    tasksGrid.innerHTML = '';
    if(tasks.length === 0) {
      tasksGrid.innerHTML = '<div class="muted tiny" style="padding:10px">No tasks to show</div>';
    } else {
      tasks.forEach(t => tasksGrid.appendChild(renderTaskCard(t)));
    }
    tasksCount.textContent = state.tasks.filter(t=>t.projectId === selectedProjectId).length;
  }

  function renderTaskCard(t){
    const div = document.createElement('div');
    const overdue = t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'done';
    div.className = `task status ${t.status}`;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <h4>${escapeHtml(t.title)}</h4>
          <div class="small-muted tiny">${escapeHtml((t.description||'').slice(0,120))}</div>
          <div style="margin-top:8px" class="muted tiny">
            ${t.assigneeId ? `<span class="tag">${escapeHtml(getUserName(t.assigneeId))}</span>` : `<span class="tag">Unassigned</span>`}
            <span class="tag">${escapeHtml(cap(t.priority))}</span>
            ${t.dueDate ? `<span class="tag">${escapeHtml(t.dueDate)}${overdue ? ' • overdue' : ''}</span>` : ''}
          </div>
        </div>
        <div style="text-align:right">
          <div class="meta tiny">${escapeHtml(cap(t.status))}</div>
          <div style="margin-top:8px">
            <button class="link-like" data-action="edit" data-id="${t.id}">Edit</button>
            <button class="link-like" data-action="del" data-id="${t.id}">Delete</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="pill" data-action="mark" data-id="${t.id}" data-status="todo">Todo</button>
        <button class="pill" data-action="mark" data-id="${t.id}" data-status="in-progress">In Progress</button>
        <button class="pill" data-action="mark" data-id="${t.id}" data-status="done">Done</button>
      </div>
    `;
    // attach handlers
    div.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const act = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if(act === 'edit') openEditTask(id);
        else if(act === 'del') { if(confirm('Delete task?')) { deleteTask(id); } }
        else if(act === 'mark') updateTaskStatus(id, btn.getAttribute('data-status'));
      });
    });
    return div;
  }

  function renderProjectMembers(){
    const project = state.projects.find(p=>p.id===selectedProjectId);
    if(!project) return;
    projectMembersDiv.innerHTML = '';
    project.members.forEach(mid=>{
      const m = state.users.find(u=>u.id===mid);
      const el = document.createElement('div');
      el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
      el.innerHTML = `<div class="avatar">${escapeHtml(shortName(m.name))}</div>
        <div style="flex:1"><div style="font-weight:700">${escapeHtml(m.name)}</div><div class="small-muted tiny">${escapeHtml(m.email||'')}</div></div>
        <div><button class="link-like" data-id="${m.id}">Remove</button></div>`;
      el.querySelector('button').addEventListener('click', ()=>{
        if(confirm('Remove member from project?')) {
          project.members = project.members.filter(x=>x!==m.id);
          // unassign their tasks within this project
          state.tasks.forEach(t=>{ if(t.projectId===project.id && t.assigneeId===m.id) t.assigneeId = null; });
          saveState();
          renderProjectMembers();
          renderTasksForSelected();
          renderProjectsList();
        }
      });
      projectMembersDiv.appendChild(el);
    });
    // populate add member select (only users not already members)
    addMemberSelect.innerHTML = '<option value="">Add member...</option>';
    state.users.forEach(u=>{
      if(!project.members.includes(u.id)) addMemberSelect.innerHTML += `<option value="${u.id}">${escapeHtml(u.name)}</option>`;
    });
  }

  // -------------------------
  // CRUD operations

  function createProject(title, desc, ownerId){
    const p = { id: 'p'+uid(6), title: title || 'Untitled project', description: desc||'', ownerId: ownerId || (state.users[0] && state.users[0].id) || null, members: [], createdAt: now() };
    state.projects.unshift(p);
    saveState();
    selectedProjectId = p.id;
    renderAll();
    return p;
  }

  function editProject(id, data){
    const p = state.projects.find(x=>x.id===id);
    if(!p) return;
    Object.assign(p, data);
    saveState();
    renderAll();
  }

  function deleteProject(id){
    state.projects = state.projects.filter(p=>p.id!==id);
    state.tasks = state.tasks.filter(t=>t.projectId!==id);
    saveState();
    selectedProjectId = null;
    renderAll();
  }

  function createTask(t){
    const task = Object.assign({
      id: 't'+uid(7),
      title: t.title || 'Untitled task',
      description: t.description || '',
      projectId: t.projectId,
      assigneeId: t.assigneeId || null,
      status: t.status || 'todo',
      priority: t.priority || 'medium',
      dueDate: t.dueDate || null,
      createdAt: now()
    }, {});
    state.tasks.unshift(task);
    saveState();
    renderTasksForSelected();
    renderProjectsList();
    return task;
  }

  function updateTask(id, changes){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    Object.assign(t, changes);
    saveState();
    renderTasksForSelected();
    renderProjectsList();
  }

  function deleteTask(id){
    state.tasks = state.tasks.filter(x=>x.id!==id);
    saveState();
    renderTasksForSelected();
    renderProjectsList();
  }

  function addUser(name, email){
    if(!name || !name.trim()) { alert('Name required'); return; }
    const u = { id: 'u'+uid(6), name: name.trim(), email: email ? email.trim() : '', createdAt: now() };
    state.users.push(u);
    saveState();
    renderUsers();
    renderProjectSelectOptions();
    return u;
  }

  function removeUser(id){
    // remove from users, unassign tasks and remove from projects
    state.users = state.users.filter(u=>u.id!==id);
    state.projects.forEach(p=>{ p.members = p.members.filter(m=>m!==id); if(p.ownerId === id) p.ownerId = (state.users[0] && state.users[0].id) || null; });
    state.tasks.forEach(t=>{ if(t.assigneeId===id) t.assigneeId = null; });
    saveState();
    renderAll();
  }

  // -------------------------
  // Helpers for UI actions

  function selectProject(id){
    selectedProjectId = id;
    renderProjectView();
    renderProjectsList();
    // scroll main to top
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function openCreateProject(){
    const title = prompt('Project title:');
    if(!title) return;
    const desc = prompt('Description (optional):') || '';
    let ownerId = (state.users[0] && state.users[0].id) || null;
    const p = createProject(title, desc, ownerId);
    // add owner as member automatically
    if(ownerId) { p.members.push(ownerId); saveState(); renderProjectView();}
  }

  function editSelectedProject(){
    if(!selectedProjectId) return alert('No project selected');
    const p = state.projects.find(x=>x.id===selectedProjectId);
    const title = prompt('Edit title:', p.title);
    if(title === null) return;
    const desc = prompt('Edit description:', p.description);
    if(desc === null) return;
    editProject(p.id, { title: title, description: desc });
  }

  function deleteSelectedProject(){
    if(!selectedProjectId) return;
    if(confirm('Delete project and its tasks?')) {
      deleteProject(selectedProjectId);
    }
  }

  function createTaskFromForm(){
    if(!selectedProjectId) return alert('Select a project first');
    if(!newTaskTitle.value.trim()) return alert('Task title required');
    createTask({
      projectId: selectedProjectId,
      title: newTaskTitle.value.trim(),
      description: newTaskDesc.value.trim(),
      assigneeId: newTaskAssignee.value || null,
      priority: newTaskPriority.value,
      dueDate: newTaskDue.value || null,
      status: newTaskStatus.value
    });
    clearTaskForm();
  }

  function clearTaskForm(){
    newTaskTitle.value=''; newTaskDesc.value=''; newTaskAssignee.value=''; newTaskPriority.value='medium'; newTaskDue.value=''; newTaskStatus.value='todo';
  }

  function openEditTask(id){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    const title = prompt('Edit task title:', t.title);
    if(title === null) return;
    const desc = prompt('Edit description:', t.description);
    if(desc === null) return;
    const status = prompt('Status (todo,in-progress,done):', t.status);
    if(status === null) return;
    const priority = prompt('Priority (low,medium,high):', t.priority);
    if(priority === null) return;
    const due = prompt('Due date (YYYY-MM-DD) or empty:', t.dueDate||'');
    updateTask(id, { title, description: desc, status: status||t.status, priority: priority||t.priority, dueDate: due || null });
  }

  function updateTaskStatus(id, status){
    updateTask(id, { status });
  }

  function addUserFromInputs(){
    const n = $('#userName').value.trim();
    const e = $('#userEmail').value.trim();
    if(!n) return alert('Enter a name');
    addUser(n,e);
    $('#userName').value=''; $('#userEmail').value='';
  }

  function addMemberToProject(){
    if(!selectedProjectId) return alert('Select a project');
    const v = addMemberSelect.value;
    if(!v) return;
    const p = state.projects.find(x=>x.id===selectedProjectId);
    if(!p) return;
    if(!p.members.includes(v)) p.members.push(v);
    saveState();
    renderProjectMembers();
    renderProjectsList();
  }

  // -------------------------
  // Small helpers
  function getUserName(id){ const u = state.users.find(x=>x.id===id); return u ? u.name : null; }
  function taskCountForProject(pId){ return state.tasks.filter(t=>t.projectId===pId).length; }
  function getProjectProgress(pId){
    const tasks = state.tasks.filter(t=>t.projectId===pId);
    if(tasks.length === 0) return 0;
    const done = tasks.filter(t=>t.status === 'done').length;
    return Math.round((done/tasks.length)*100);
  }
  function cap(s){ if(!s) return ''; return s.split('-').map(x=> x.charAt(0).toUpperCase()+x.slice(1)).join(' '); }
  function shortName(name){ if(!name) return '?'; return name.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase(); }
  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }

  // -------------------------
  // Misc: Help modal (simple)
  function showHelp(){
    alert(`Project Manager - Single file
- Create projects (New)
- Add team members in the left panel
- Select a project to add tasks, assign users, set due dates and status
- Use Export/Import JSON to backup or move data
- Keyboard shortcuts: n = new project, u = add user focus, t = focus new task
- Data stored locally in your browser (localStorage).`);
  }

  // Initialize storage if empty
  if(!localStorage.getItem(lsKey)) {
    state = clone(sample);
    saveState();
  } else {
    saveState();
  }

  // Expose a couple functions for debugging (optional)
  window.__pm = {
    getState: ()=>clone(state),
    resetToSample: ()=>{ if(confirm('Reset to sample?')){ state = clone(sample); saveState(); selectedProjectId=null; renderAll(); } }
  };

})();
</script>
</body>
</html>
